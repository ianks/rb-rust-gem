FROM conanio/clang9-x86 as clang
FROM larskanis/rake-compiler-dock-mri-x86-linux:1.2.0

ENV RUBY_TARGET="x86-linux" \
    RUST_TARGET="i686-unknown-linux-gnu" \
    RUST_TOOLCHAIN="stable" \
    BINDGEN_EXTRA_CLANG_ARGS="--sysroot=/usr -I/usr/lib/gcc/i686-redhat-linux/4.8.2/include" \
    PKG_CONFIG_ALLOW_CROSS="1" \
    RUSTUP_HOME="/usr/local/rustup" \
    CARGO_HOME="/usr/local/cargo" \
    PATH="/usr/local/cargo/bin:$PATH" \
    LIBCLANG_PATH="/usr/lib/llvm/lib"

RUN set -eux; \
    echo "export PATH=/usr/local/cargo/bin:\$PATH" >> /etc/rubybashrc; \
    echo "export RUSTUP_HOME=\"$RUSTUP_HOME\"" >> /etc/rubybashrc; \
    echo "export CARGO_HOME=\"$CARGO_HOME\"" >> /etc/rubybashrc; \
    echo "export RUBY_TARGET=\"$RUBY_TARGET\"" >> /etc/rubybashrc; \
    echo "export RUST_TARGET=\"$RUST_TARGET\"" >> /etc/rubybashrc; \
    echo "export RUST_TOOLCHAIN=\"$RUST_TOOLCHAIN\"" >> /etc/rubybashrc; \
    echo "export BINDGEN_EXTRA_CLANG_ARGS=\"$BINDGEN_EXTRA_CLANG_ARGS\"" >> /etc/rubybashrc; \
    echo "export PKG_CONFIG_ALLOW_CROSS=\"$PKG_CONFIG_ALLOW_CROSS\"" >> /etc/rubybashrc; \
    echo "export LIBCLANG_PATH=\"$LIBCLANG_PATH\"" >> /etc/rubybashrc; \
    echo "export CARGO_BUILD_TARGET=\"$RUST_TARGET\"" >> /etc/rubybashrc;

RUN set -eux; \
    url="https://static.rust-lang.org/rustup/dist/i686-unknown-linux-gnu/rustup-init"; \
    curl --retry 3 --proto '=https' --tlsv1.2 -sSf "$url" > rustup-init; \
    chmod +x rustup-init; \
    ./rustup-init --no-modify-path --default-toolchain "$RUST_TOOLCHAIN" --profile minimal -y || true; \
    rm rustup-init; \
    chmod -R a+w $RUSTUP_HOME $CARGO_HOME; \
    rustup --version; \
    cargo --version; \
    rustc --version; \
    rustup target add i686-unknown-linux-gnu;

RUN set -eux; \
    git clone --single-branch --branch cargo-builder-target --depth 1 https://github.com/ianks/rubygems /tmp/rubygems; \
    cd /tmp/rubygems; \
    bash -c "ruby setup.rb"; \
    rm -rf /tmp/rubygems;

COPY --from=clang /usr/lib/llvm-9 /usr/lib/llvm
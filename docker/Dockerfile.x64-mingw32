ARG RCD_TAG
FROM larskanis/rake-compiler-dock-mri-x86-mingw32:${RCD_TAG}

ENV RUBY_TARGET="x64-mingw32" \
    RUST_TARGET="x86_64-pc-windows-gnu" \
    RUSTUP_DEFAULT_TOOLCHAIN="stable" \
    PKG_CONFIG_ALLOW_CROSS="1" \
    RUSTUP_HOME="/usr/local/rustup" \
    CARGO_HOME="/usr/local/cargo" \
    PATH="/usr/local/cargo/bin:$PATH"

COPY setup/lib.sh /lib.sh

COPY setup/rustup.sh /
RUN /rustup.sh x86_64-unknown-linux-gnu $RUST_TARGET $RUSTUP_DEFAULT_TOOLCHAIN

COPY setup/rubygems.sh /
RUN /rubygems.sh

RUN set -ex; \
    bash -c "source /lib.sh && install_packages zstd"; \
    wget https://mirror.msys2.org/mingw/mingw64/mingw-w64-x86_64-clang-13.0.1-3-any.pkg.tar.zst; \
    tar xf mingw-w64-x86_64-clang-13.0.1-3-any.pkg.tar.zst; \
    rm mingw-w64-x86_64-clang-13.0.1-3-any.pkg.tar.zst; \
    apt-get purge --assume-yes --auto-remove zstd;

ENV BINDGEN_EXTRA_CLANG_ARGS="" \
    LIBCLANG_PATH="/mingw64/bin/"

COPY setup/rubybashrc.sh /
RUN /rubybashrc.sh

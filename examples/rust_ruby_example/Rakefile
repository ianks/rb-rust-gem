require "rake/extensiontask"

PLATFORMS = ["x86_64-linux", "arm-linux", "aarch64-linux", "x86-linux", "x86_64-darwin", "arm64-darwin", "x86-mingw32", "x64-mingw32", "x64-mingw-ucrt"]

spec = Gem::Specification.new do |s|
  s.name = "rust_ruby_example"
  s.version = "0.1.0"
  s.platform = Gem::Platform::RUBY
  s.extensions = FileList["ext/**/extconf.rb"]
  s.summary = "Testing"
  s.authors = ["Ian Ker-Seymer"]
  s.metadata["allowed_push_host"] = "https://rubygems.pkg.github.com"
  s.metadata["github_repo"] = "git@github.com:ianks/rb-rust-gem.git"
end

Rake::ExtensionTask.new("rust_ruby_example", spec) do |ext|
  ext.cross_compile = true
  ext.cross_platform = PLATFORMS
end

Gem::PackageTask.new(spec) do |pkg|
end

PLATFORMS.each do |plat|
  task "gem:native:#{plat}" do
    require "rake_compiler_dock"
    ENV["RCD_IMAGE"] = "rbsys/rcd:#{plat}"
    sh "bundle package --all" # Avoid repeated downloads of gems by using gem files from the host.
    RakeCompilerDock.sh <<~EOS, platform: plat
      set -e
      bundle --local 
      rake -T
      rake native:#{plat} gem
    EOS
  end
end

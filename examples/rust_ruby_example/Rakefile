require 'rake/extensiontask'

PLATFORMS =  %w[x86-mingw32 x64-mingw-ucrt x64-mingw32 x86-linux x86_64-linux arm-linux aarch64-linux x86_64-darwin arm64-darwin]

spec = Gem::Specification.new do |s|
  s.name = "rust_ruby_example"
  s.version = "0.1.0"
  s.platform = Gem::Platform::RUBY
  s.extensions = FileList["ext/**/extconf.rb"]
  s.summary = "Testing"
  s.authors = ["Ian Ker-Seymer"]
end

Rake::ExtensionTask.new('rust_ruby_example', spec) do |ext|
  ext.cross_compile = true
  ext.cross_platform = PLATFORMS
end

Gem::PackageTask.new(spec) do |pkg|
end

PLATFORMS.each do |plat|
  # task "gem:native:#{plat}" do
  #   require 'rake_compiler_dock'

  #   sh "bundle package --all"   # Avoid repeated downloads of gems by using gem files from the host.
  #   RakeCompilerDock.sh <<~EOS, platform: plat
  #     set -ex

  #     if command -v yum; then
  #       sudo yum -y install llvm-toolset-7
  #       export LIBCLANG_PATH="/opt/rh/llvm-toolset-7/root/usr/lib64"
  #     fi

  #     if command -v apt-get; then
  #       # sudo dpkg --add-architecture ${{ matrix.platform.arch }}
  #       # sudo apt-get update && sudo apt-get install -y libclang-dev:${{ matrix.platform.arch }}
  #       export LIBCLANG_PATH="/usr/lib/llvm-10/lib"
  #       sudo apt-get update && sudo apt-get install -y libclang-dev clang llvm-dev libc6-armhf-cross libc6-dev-armhf-cross
  #     fi

  #     git clone --single-branch --branch cargo-builder-target --depth 1 https://github.com/ianks/rubygems /tmp/rubygems
  #     pushd /tmp/rubygems
  #     ruby setup.rb
  #     popd
  #     rm -rf /tmp/rubygems

  #     export RUST_TARGET="#{ENV.fetch('RUST_TARGET', '')}"
  #     export RUST_TOOLCHAIN="#{ENV.fetch('RUST_TOOLCHAIN', '')}"
  #     export BINDGEN_EXTRA_CLANG_ARGS="#{ENV.fetch('BINDGEN_EXTRA_CLANG_ARGS', '')}"
  #     export PKG_CONFIG_ALLOW_CROSS=1
  #     curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain "$RUST_TOOLCHAIN" --profile minimal -y
  #     export PATH=/root/.cargo/bin:$PATH
  #     source "$HOME/.cargo/env"
  #     rustup target add "$RUST_TARGET"
  #     export CARGO_BUILD_TARGET="$RUST_TARGET"

  #     bundle --local 
  #     rake native:#{plat} gem
  #   EOS
  # end

  task "gem:native:#{plat}" do
    require 'rake_compiler_dock'
    ENV['RCD_IMAGE'] = "rbsys/rake-compiler-dock-mri-#{plat}:0.1.0"
    sh "bundle package --all"   # Avoid repeated downloads of gems by using gem files from the host.
    RakeCompilerDock.sh <<~EOS, platform: plat
      set -e
      bundle --local 
      rake native:#{plat} gem
    EOS
  end
end